From c8db2685f6f164e2605146e31e2989dc5ddcb4d2 Mon Sep 17 00:00:00 2001
From: Ben Adams <thundercat@illyriad.co.uk>
Date: Mon, 11 Dec 2017 02:42:54 +0000
Subject: [PATCH] Improve Dict.Clear CQ (#15459)

---
 .../shared/System/Collections/Generic/Dictionary.cs      | 16 +++++++++++-----
 1 file changed, 11 insertions(+), 5 deletions(-)

diff --git a/src/mscorlib/shared/System/Collections/Generic/Dictionary.cs b/src/mscorlib/shared/System/Collections/Generic/Dictionary.cs
index 5771805..6bd0785 100644
--- a/src/mscorlib/shared/System/Collections/Generic/Dictionary.cs
+++ b/src/mscorlib/shared/System/Collections/Generic/Dictionary.cs
@@ -48,9 +48,9 @@ namespace System.Collections.Generic
         private int[] _buckets;
         private Entry[] _entries;
         private int _count;
-        private int _version;
         private int _freeList;
         private int _freeCount;
+        private int _version;
         private IEqualityComparer<TKey> _comparer;
         private KeyCollection _keys;
         private ValueCollection _values;
@@ -256,14 +256,20 @@ namespace System.Collections.Generic
 
         public void Clear()
         {
-            if (_count > 0)
+            int count = _count;
+            if (count > 0)
             {
-                for (int i = 0; i < _buckets.Length; i++) _buckets[i] = -1;
-                Array.Clear(_entries, 0, _count);
-                _freeList = -1;
+                int[] buckets = _buckets;
+                for (int i = 0; i < buckets.Length; i++)
+                {
+                    buckets[i] = -1;
+                }
+
                 _count = 0;
+                _freeList = -1;
                 _freeCount = 0;
                 _version++;
+                Array.Clear(_entries, 0, count);
             }
         }
 
-- 
2.7.4

